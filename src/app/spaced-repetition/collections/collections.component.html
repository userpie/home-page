<div class="flashcard-arrays-container">
  <div class="header-section">
    <div class="header-content">
      <div class="title-group">
        <h2>Collections</h2>
      </div>
      <div class="header-buttons">
        <button type="button" class="round-btn create-btn" (click)="showAddForm.set(true)" title="Create New Collection">
        </button>
        <button type="button" class="round-btn reset-btn" (click)="openResetModal()" title="Reset to Default Collections">
          <span class="sr-only">Reset</span>
        </button>
      </div>
    </div>
  </div>

  @if (!showAddForm() && !isLoading()) {
    <div class="search-section">
      <div class="search-and-sort-container">
        <div class="search-input-container">
          <input
            type="text"
            class="search-input"
            placeholder="Search by name or description..."
            [value]="searchQuery()"
            (input)="onSearchChange($event)"
          />
        </div>

        <div class="sort-container">
          <label for="sort-select" class="sort-label">Sort by:</label>
          <select
            id="sort-select"
            class="sort-select"
            [value]="sortOrder()"
            (change)="onSortChange($event)"
          >
            <option value="desc">Newest First</option>
            <option value="asc">Oldest First</option>
          </select>
        </div>
      </div>
    </div>

    <div class="arrays-list">
    @for (collectionMetadata of filteredCollections(); track collectionMetadata.id) {
      <div
        class="array-card"
        [class.selected]="isSelected(collectionMetadata.id)"
        (click)="selectArray(collectionMetadata.id)"
      >
        <div class="array-header">
          <div class="title-section">
            <h3>{{ collectionMetadata.name }}</h3>
            @if (isSelected(collectionMetadata.id)) {
              <span class="selected-badge">Selected</span>
            }
          </div>
          <div class="header-right">
            <span class="total-cards">{{ collectionMetadata.totalCards }} cards</span>
            @if (isSelected(collectionMetadata.id)) {
              <div class="action-buttons">
                <button type="button" class="round-btn edit-btn" (click)="editCollection($event, collectionMetadata)" title="Edit Collection">
                </button>
                <button type="button" class="round-btn delete-btn" (click)="deleteCollection($event, collectionMetadata)" title="Delete Collection">
                </button>
              </div>
            }
          </div>
        </div>

        <div class="array-details">
          <p class="description">{{ collectionMetadata.description }}</p>

          <div class="statistics">
            <div class="stat-item">
              <span class="label">Average length:</span>
              <span class="value">{{ collectionMetadata.statistics.averageBackLength }}</span>
            </div>
            <div class="stat-item">
              <span class="label">Range:</span>
              <span class="value"
              >{{ collectionMetadata.statistics.minBackLength }} - {{ collectionMetadata.statistics.maxBackLength }}</span
              >
            </div>
          </div>

          <div class="length-distribution">
            <h4>Length Distribution:</h4>
            <div class="distribution-items">
              @for (item of getLengthDistributionEntries(collectionMetadata.lengthDistribution); track item.length) {
                <span class="distribution-item"> {{ item.length }}ch: {{ item.count }} </span>
              }
            </div>
          </div>

          @if (isSelected(collectionMetadata.id)) {
            <div class="action-section">
              <button type="button" class="start-study-btn" (click)="startStudying($event, collectionMetadata)">
                Start Studying This Array
              </button>
            </div>
          }
        </div>
      </div>
    }
    </div>
  } @else {
  <div class="add-array-form">
    <h3>{{ editingCollectionId() ? 'Edit Collection' : 'Add New Collection' }}</h3>
    <form [formGroup]="collectionForm" (ngSubmit)="addCollection()">
      <div class="form-group">
        <label for="name">Collection name:</label>
        <input
          id="name"
          formControlName="name"
          placeholder="Enter a name for the collection"
          type="text"
        />
      </div>

      <div class="form-group">
        <label for="description">Description:</label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="Enter a description for the collection"
          rows="3"
        >
        </textarea>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="collectionForm.invalid" class="btn btn-primary">
          {{ editingCollectionId() ? 'Update Collection' : 'Add Collection' }}
        </button>
        <button type="button" (click)="cancelAddCollection()" class="btn btn-secondary">Cancel</button>
      </div>
    </form>
  </div>
  }

  @if (showResetModal()) {
    <div class="modal-overlay" (click)="hideResetModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Reset Collections</h3>
        </div>
        <div class="modal-body">
          <p><strong>Warning:</strong> This action will permanently delete all your custom collections and flashcards, and restore the default collections.</p>
          <p>This action cannot be undone. Are you sure you want to continue?</p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" (click)="resetToDefaults()">
            Reset Everything
          </button>
          <button type="button" class="btn btn-secondary" (click)="hideResetModal()">
            Cancel
          </button>
        </div>
      </div>
    </div>
  }

</div>
