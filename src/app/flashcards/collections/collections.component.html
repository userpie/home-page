<div class="flashcard-arrays-container">
  <div class="header-section">
    <div class="header-content">
      <div class="header-buttons">
        <app-button [title]="'Reset to Default Collections'"
                    [icon]="assetUrlService.getResetIconUrl()"
                    [backgroundColor]="'#f8d7da'"
                    [hoverColor]="'#f5c6cb'"
                    (click)="openResetModal()"
        ></app-button>
        <app-button [title]="'Create New Collection'"
                    [icon]="assetUrlService.getAddIconUrl()"
                    [backgroundColor]="'#fff3cd'"
                    [hoverColor]="'#ffeaa7'"
                    (click)="showAddForm.set(true)"
        ></app-button>
        <app-button [title]="'Start Selected Collections'"
                    [icon]="assetUrlService.getStartAllIconUrl()"
                    [backgroundColor]="'#d4edda'"
                    [hoverColor]="'#c3e6cb'"
                    (click)="startStudyingSelectedCollections()"
        ></app-button>
      </div>
    </div>
  </div>

  @if (!showAddForm() && !isLoading()) {
    <div class="search-section">
      <div class="search-and-sort-container">
        <div class="search-input-container">
          <input
            type="text"
            class="search-input"
            [placeholder]="'flashcards.search-input-placeholder' | translate"
            [value]="searchQuery()"
            (input)="onSearchChange($event)"
          />
        </div>

        <div class="sort-container">
          <label for="sort-by-select" class="sort-label">{{ 'flashcards.sort-by-select' | translate }}</label>
          <select
            id="sort-by-select"
            class="sort-select"
            [value]="sortBy()"
            (change)="onSortByChange($event)"
          >
            <option value="createdAt">{{ 'flashcards.sort-by-created' | translate }}</option>
            <option value="name">{{ 'flashcards.sort-by-name' | translate }}</option>
            <option value="totalCards">{{ 'flashcards.sort-by-total' | translate }}</option>
            <option value="dueCards">{{ 'flashcards.sort-by-due' | translate }}</option>
            <option value="wordLength">{{ 'flashcards.sort-by-word-length' | translate }}</option>
          </select>
        </div>

        <div class="sort-container">
          <label for="sort-select" class="sort-label">{{ 'flashcards.sort-select' | translate }}</label>
          <select
            id="sort-select"
            class="sort-select"
            [value]="sortOrder()"
            (change)="onSortChange($event)"
          >
            <option value="desc">{{ 'flashcards.sort-desc' | translate }}</option>
            <option value="asc">{{ 'flashcards.sort-asc' | translate }}</option>
          </select>
        </div>

        <div class="starred-filter-container">
          <app-star-button
            [starred]="starredFirst()"
            (toggle)="starredFirst.set(!starredFirst())"
          />
        </div>
      </div>
    </div>

    <div class="arrays-list">
      @for (collectionMetadata of filteredCollections(); track collectionMetadata.id) {
        <div
          class="array-card"
          [class.selected]="isSelected(collectionMetadata.id)"
          (click)="toggleSelection(collectionMetadata.id)"
        >
          <div class="array-header">
            <div class="title-section">
              <app-star-button
                [starred]="collectionMetadata.starred"
                (toggle)="toggleStarred(collectionMetadata)"
              />
              <h3>{{ collectionMetadata.name }}</h3>
            </div>
            <div class="header-right">
              @if (isSelected(collectionMetadata.id)) {
                <div class="action-buttons">
                  <app-button
                    [title]="'Deleting Collection'"
                    [size]="ButtonSize.SMALL"
                    [icon]="assetUrlService.getDeleteIconUrl()"
                    [backgroundColor]="'#f8d7da'"
                    [hoverColor]="'#f5c6cb'"
                    (click)="deleteCollection(collectionMetadata)"
                  ></app-button>
                  <app-button
                    [title]="'Edit Collection'"
                    [size]="ButtonSize.SMALL"
                    [icon]="assetUrlService.getEditIconUrl()"
                    [backgroundColor]="'#fff3cd'"
                    [hoverColor]="'#ffeaa7'"
                    (click)="editCollection(collectionMetadata)"
                  ></app-button>
                  <app-button
                    [title]="'Start'"
                    [size]="ButtonSize.SMALL"
                    [icon]="assetUrlService.getStartIconUrl()"
                    [backgroundColor]="'#d4edda'"
                    [hoverColor]="'#c3e6cb'"
                    (click)="startStudying(collectionMetadata)"
                  ></app-button>
                </div>
              }
              @let dueCards = getDueCards(collectionMetadata);
              <span class="total-cards"
                    [class.all-done]="dueCards === 0"
                    [class.none-done]="dueCards===collectionMetadata.totalCards">
                {{ dueCards }} {{ 'flashcards.cards' | translate }}
              </span>
            </div>
          </div>

          <div class="array-details">
            <p class="description">{{ collectionMetadata.description }}</p>
            <div class="statistics">
              <div class="stat-item">
                <span class="label">{{ 'flashcards.range' | translate }}</span>
                <span class="value">
                  {{
                    collectionMetadata.statistics.minBackLength === collectionMetadata.statistics.maxBackLength
                      ? collectionMetadata.statistics.minBackLength
                      : collectionMetadata.statistics.minBackLength + ' - ' + collectionMetadata.statistics.maxBackLength
                  }}
                </span>
              </div>
              <div class="stat-item">
                <span class="label">{{ 'flashcards.total' | translate }}</span>
                <span class="value">{{ collectionMetadata.totalCards }}
                </span>
              </div>
              <div class="stat-item">
                <span class="label">{{ 'flashcards.length-distribution' | translate }}</span>
                <div class="distribution-items">
                  @for (item of getLengthDistributionEntries(collectionMetadata.lengthDistribution); track item.length) {
                    <span class="distribution-item" [class]="getDistributionItemColorClass(item.length)"> {{ item.length }}ch: {{ item.count }} </span>
                  }
                </div>
              </div>
            </div>

          </div>
        </div>
      }
    </div>
  } @else {
    <div class="add-array-form">
      <h3>{{ (editingCollectionId() ? 'flashcards.edit-collection' : 'flashcards.add-collection') | translate }}</h3>
      <form [formGroup]="collectionForm" (ngSubmit)="addCollection()">
        <div class="form-group">
          <label for="name">{{ 'flashcards.collection-name' | translate }}</label>
          <input
            id="name"
            formControlName="name"
            [placeholder]="'flashcards.name-input-placeholder' | translate"
            type="text"
          />
        </div>

        <div class="form-group">
          <label for="description">{{ 'flashcards.description' | translate }}</label>
          <textarea
            id="description"
            formControlName="description"
            [placeholder]="'flashcards.desc-input-placeholder' | translate"
            rows="3"
          >
        </textarea>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="collectionForm.invalid" class="btn btn-primary">
            {{ (editingCollectionId() ? 'flashcards.confirm-edit-collection' : 'flashcards.confirm-add-collection') | translate }}
          </button>
          <button type="button" (click)="cancelAddCollection()"
                  class="btn btn-secondary">{{ 'common.cancel' | translate }}
          </button>
        </div>
      </form>
    </div>
  }

  @if (showResetModal()) {
    <div class="modal-overlay" (click)="hideResetModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ 'flashcards.reset-modal.title' | translate }}</h3>
        </div>
        <div class="modal-body">
          <p>{{ 'flashcards.reset-modal.message' | translate }}</p>
          <p>{{ 'flashcards.reset-modal.ask-confirm' | translate }}</p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-danger" (click)="resetToDefaults()">
            {{ 'flashcards.reset-modal.confirm-button' | translate }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="hideResetModal()">
            {{ 'common.cancel' | translate }}
          </button>
        </div>
      </div>
    </div>
  }

</div>
